---
title: "Potts_Data_Science_Assessment"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(rvest)
library(stringr)
library(stringi)
library(ggbreak)
library(ggplot2)
```

### Question 1
#### Q1 (a) Using R or Python scrape the wikipedia page on natural disasters: https://en.wikipedia.org/wiki/List_of_natural_disasters_by_death_toll for the tables of the 20th and 21st century all cause disasters into a data frame, tibble or pandas data frame.

```{r}
url = "https://en.wikipedia.org/wiki/List_of_natural_disasters_by_death_toll" 
disaster_tab = read_html(url) %>% # Parse an html table into df
  html_table()

# saving the 20th and 21st tables from the webpage 
tw_cent = disaster_tab[[3]] %>% 
  janitor::clean_names()

twfirst_cent = disaster_tab[[4]] %>% 
  janitor::clean_names()
```


#### Q1 (b) Convert the death toll to numbers using the midpoints when a range is given and the bound when an upper or lower bound is given (example 20,000+ converts to 20000).

To clean the death_toll variable, we remove any extraneous elements, such as commas, a citation [#], +, or (estimate), as well as extracting the midpoint from any ranges.
```{r}
# cleaning process for 20th century df
tw_cent2 = tw_cent %>% 
  mutate(orig_death_toll = death_toll) %>% # create copy of death toll to check against
  mutate(death_toll = str_replace_all(death_toll, "[,+]", "")) %>% # remove , and +
  mutate(death_toll = gsub("\\[[^][]*]", "", death_toll)) %>% # remove [#]
  mutate(lower_bound = stri_extract_first_regex(death_toll, "[0-9]+")) %>% # separate ranges into upper and lower bounds
  mutate(upper_bound = stri_extract_last_regex(death_toll, "[0-9]+")) %>% 
  mutate(midpoint = (as.numeric(upper_bound) + as.numeric(lower_bound))/2) %>% # calculate midpoint
  mutate(death_toll = ifelse(lower_bound == upper_bound, lower_bound, midpoint)) %>% select(-c("upper_bound", "lower_bound", "midpoint")) # condense clean death_toll into one desired column

head(tw_cent2)

# cleaning process for 21th century df
twfirst_cent2 = twfirst_cent %>% 
  mutate(orig_death_toll = death_toll) %>% # create copy of death toll to check against
  mutate(death_toll = str_replace_all(death_toll, "[,+]", "")) %>% # remove , and +
  mutate(death_toll = gsub("\\s*\\([^\\)]+\\)", "", death_toll)) %>% # remove (estimate)
  mutate(death_toll = gsub("\\[[^][]*]", "", death_toll)) %>% # remove [#]
  mutate(lower_bound = stri_extract_first_regex(death_toll, "[0-9]+")) %>% # separate ranges into upper and lower bounds
  mutate(upper_bound = stri_extract_last_regex(death_toll, "[0-9]+")) %>% 
  mutate(midpoint = (as.numeric(upper_bound) + as.numeric(lower_bound))/2) %>% # calculate midpoint
  mutate(death_toll = ifelse(lower_bound == upper_bound, lower_bound, midpoint)) %>% select(-c("upper_bound", "lower_bound", "midpoint")) # condense clean death_toll into one desired column

head(twfirst_cent2)
```

#### Q1 (c) Merge the 20th and 21st century data frames and plot the death toll (vertical / y axis) by year (horizontal / x axis) color coded by kind of disaster.

We make note that some observations have more than one type, and make the decision to color based on the first type listed. While not ideal to add an axis break for the death toll, the graph was quite difficult to see major trends without doing so for the extreme value of over 2,000,000.
```{r}
df = rbind(tw_cent2, twfirst_cent2) %>% # stack vertically
  mutate(type = str_to_sentence(type)) %>% 
  mutate(type = gsub("(.*),.*", "\\1", type)) %>% # isolate type
  mutate(type = as.factor(type)) %>% # fix data types for plotting
  mutate(death_toll = as.numeric(death_toll))

ggplot(df, aes(x=year, y=death_toll, color=type)) + geom_point() + # scatterplot
  labs(title = "Deadliest All Cause Natural Disaster per Year", subtitle = "(1900-2024)") + xlab("Year") + ylab("Death Toll") + # aesthetics
  scale_y_continuous(labels = scales::comma, limits = c(0, 2211252), breaks = c(0, 100000, 200000, 300000, 400000, 500000, 2211250)) + scale_y_break(c(500000, 2211249), scales = 0.15) +
  theme(axis.text.y.right = element_blank(),
        axis.ticks.y.right = element_blank(),
        axis.title.y.right = element_blank()) + 
  scale_x_continuous(limits = c(1900, 2024), 
                     breaks = seq(1900, 2024, by = 50)) + 
  guides(color = guide_legend(title = "Disaster Type")) 

```
